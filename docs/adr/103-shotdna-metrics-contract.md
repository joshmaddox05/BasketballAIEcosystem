# ADR-103: ShotDNA Metrics JSON Contract

**Date:** 2025-01-17  
**Status:** Accepted  
**Deciders:** Development Team  

## Context

T-103 requires creating a comprehensive JSON schema contract for ShotDNA metrics that will be generated by AI models. This contract defines the structure, validation rules, and data types for basketball shot analysis metrics.

## Decision

Implement a comprehensive ShotDNA metrics contract with the following components:

### JSON Schema (`/docs/shotdna.metrics.schema.json`)
- Complete JSON Schema v7 specification
- Required and optional field definitions
- Validation rules and constraints
- Examples and documentation
- Type definitions for all metrics

### Backend Validation (`/backend/src/middleware/shotdnaValidation.ts`)
- Zod-based validation middleware
- Runtime type checking
- Detailed error reporting
- Helper functions for individual metric validation
- Sample data generation for testing

### API Endpoints
- `POST /shots/:videoId/metrics` - Submit shot analysis metrics
- `GET /shots` - List user's shot analyses
- `GET /shots/:shotId` - Get specific shot analysis

## Implementation Details

### Core Metrics (Required)
- **release_ms**: Time from shot start to ball release (100-2000ms)
- **elbow_angle_deg**: Elbow angle at release (0-180°)
- **wrist_flick_deg_s**: Wrist flick velocity (0-1000 deg/s)
- **arc_proxy_deg**: Shooting arc angle (0-90°)
- **consistency_score**: Overall consistency (0.0-1.0)
- **tips**: AI-generated improvement suggestions (1-5 items, 10-200 chars each)
- **model_version**: AI model version identifier

### Optional Scores
- **form_score**: Technique quality (0.0-1.0)
- **timing_score**: Rhythm and timing (0.0-1.0)
- **overall_score**: Composite quality score (0.0-1.0)

### Advanced Data (Optional)
- **improvements**: Specific areas for improvement
- **keypoints**: Body joint detection data
- **trajectory**: Ball trajectory analysis
- **analysis_metadata**: Processing and detection info

### Validation Rules
- Numeric ranges enforced (e.g., angles 0-180°, scores 0-1)
- String length limits (tips 10-200 chars)
- Array size constraints (tips 1-5 items)
- Pattern matching (model version format)
- Enum validation (shot types, results)

## Technical Specifications

### JSON Schema Features
- **Type Safety**: Strict typing for all fields
- **Range Validation**: Min/max constraints for numeric values
- **String Constraints**: Length limits and pattern matching
- **Array Validation**: Size and item type constraints
- **Enum Validation**: Predefined value sets
- **Nested Objects**: Complex data structures for keypoints and trajectory

### Backend Validation
- **Zod Integration**: Type-safe runtime validation
- **Middleware Pattern**: Reusable validation across endpoints
- **Error Details**: Specific field-level error reporting
- **Type Inference**: Automatic TypeScript type generation
- **Helper Functions**: Individual metric validation utilities

### API Design
- **RESTful Endpoints**: Standard HTTP methods and status codes
- **Authentication**: Firebase JWT required for all endpoints
- **Request Validation**: Automatic schema validation
- **Response Format**: Consistent error and success responses
- **OpenAPI Documentation**: Auto-generated API docs

## Data Flow

### Metric Submission
1. AI model generates shot analysis
2. Metrics validated against schema
3. Data stored in database
4. Shot ID returned to client
5. Processing status tracked

### Metric Retrieval
1. User requests shot analyses
2. Database queried with filters
3. Metrics returned with metadata
4. Optional filtering by status/date

### Error Handling
1. Validation errors return 400 with details
2. Authentication errors return 401
3. Server errors return 500
4. All errors include request ID for tracking

## Validation Examples

### Valid Metrics
```json
{
  "release_ms": 540,
  "elbow_angle_deg": 97.2,
  "wrist_flick_deg_s": 480.5,
  "arc_proxy_deg": 44.0,
  "consistency_score": 0.76,
  "tips": [
    "Raise elbow to 95–100° range",
    "Earlier release by ~60–100 ms"
  ],
  "model_version": "tflite-v0.1.0"
}
```

### Invalid Metrics (Validation Errors)
- `release_ms: 50` → Too low (min 100)
- `elbow_angle_deg: 200` → Too high (max 180)
- `tips: ["Short"]` → Too short (min 10 chars)
- `model_version: "Invalid!"` → Invalid format

## Testing Strategy

### Unit Tests
- Individual metric validation
- Schema parsing and validation
- Error message accuracy
- Helper function testing

### Integration Tests
- API endpoint validation
- Authentication requirements
- Error response formats
- Success response structures

### Contract Tests
- Schema compliance verification
- Example data validation
- Edge case testing
- Performance validation

## Monitoring and Analytics

### Metrics to Track
- Validation success/failure rates
- Common validation errors
- API endpoint usage
- Processing times

### Events to Log
- Metric submission attempts
- Validation failures
- Successful submissions
- Error types and frequencies

## Future Considerations

- **Schema Evolution**: Versioning strategy for schema changes
- **Performance**: Large keypoint arrays optimization
- **Caching**: Validation result caching
- **Streaming**: Real-time metric validation
- **Machine Learning**: Validation rule learning from data

## Security Considerations

- **Input Sanitization**: All string inputs validated
- **Range Limits**: Prevent numeric overflow attacks
- **Size Limits**: Prevent large payload attacks
- **Type Safety**: Prevent injection via type confusion
- **Authentication**: All endpoints require valid JWT

## Performance Optimizations

- **Fast Validation**: Zod optimized for speed
- **Minimal Parsing**: Only validate required fields
- **Error Caching**: Common error patterns cached
- **Async Processing**: Non-blocking validation
- **Memory Management**: Efficient object handling

## Acceptance Criteria

✅ JSON Schema v7 specification created  
✅ Zod validation middleware implemented  
✅ API endpoints for metric submission/retrieval  
✅ Comprehensive validation rules  
✅ Detailed error reporting  
✅ TypeScript type generation  
✅ Unit and integration tests  
✅ OpenAPI documentation  

## How I Verified

1. **Schema Validation**: Tested JSON schema with various inputs
   ```bash
   # Test schema validation
   curl -X POST http://localhost:3000/shots/video123/metrics \
     -H "Authorization: Bearer <token>" \
     -H "Content-Type: application/json" \
     -d @test-metrics.json
   ```

2. **Unit Tests**: Verified validation logic
   ```bash
   cd backend && npm test -- --testPathPattern=shotdna.test.ts
   ```

3. **API Documentation**: Checked OpenAPI docs at http://localhost:3000/docs

4. **Error Handling**: Tested various invalid inputs
   - Missing required fields
   - Invalid numeric ranges
   - Malformed strings
   - Invalid enum values

5. **Type Safety**: Verified TypeScript compilation
   ```bash
   cd backend && npm run build
   ```
